# My RPC Framework

[![Java Version](https://img.shields.io/badge/Java-17-blue.svg)](https://www.oracle.com/java/technologies/javase/jdk17-archive-downloads.html)
[![Maven](https://img.shields.io/badge/Maven-3.x-red.svg)](https://maven.apache.org/)
[![Netty](https://img.shields.io/badge/Netty-4.1.128-green.svg)](https://netty.io/)

ä¸€ä¸ªåŸºäº Netty å’Œ fastjson2 çš„é«˜æ€§èƒ½ RPC æ¡†æ¶ï¼Œæä¾›å®Œæ•´çš„åˆ†å¸ƒå¼æœåŠ¡è°ƒç”¨èƒ½åŠ›ã€‚

## ç›®å½•

- [ç‰¹æ€§](#ç‰¹æ€§)
- [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
- [æ ¸å¿ƒåŠŸèƒ½](#æ ¸å¿ƒåŠŸèƒ½)
- [æŠ€æœ¯å®ç°](#æŠ€æœ¯å®ç°)
- [é…ç½®è¯¦è§£](#é…ç½®è¯¦è§£)
- [æ‰©å±•å¼€å‘](#æ‰©å±•å¼€å‘)
- [ä¸è¶³ä¸æ”¹è¿›](#ä¸è¶³ä¸æ”¹è¿›)

---

## ç‰¹æ€§

### æ ¸å¿ƒèƒ½åŠ›
- âœ… **é«˜æ€§èƒ½ç½‘ç»œé€šä¿¡**ï¼šåŸºäº Netty å®ç°å¼‚æ­¥éé˜»å¡ I/O
- âœ… **æœåŠ¡æ³¨å†Œå‘ç°**ï¼šæ”¯æŒ Zookeeper æ³¨å†Œä¸­å¿ƒ
- âœ… **å¤šç§åºåˆ—åŒ–æ–¹å¼**ï¼šJSON (é»˜è®¤)ã€Hessian
- âœ… **æ™ºèƒ½æ•°æ®å‹ç¼©**ï¼šGZIPã€Zstandardï¼Œè‡ªåŠ¨æ ¹æ®æ•°æ®å¤§å°é€‰æ‹©
- âœ… **è´Ÿè½½å‡è¡¡**ï¼šRandomã€RoundRobin
- âœ… **çµæ´»é‡è¯•ç­–ç•¥**ï¼šSameã€Failoverã€FailoverOnceã€Forking
- âœ… **æµé‡æ§åˆ¶**ï¼šä»¤ç‰Œæ¡¶é™æµ + å¹¶å‘æ•°é™æµ
- âœ… **ç†”æ–­ä¿æŠ¤**ï¼šå“åº”æ—¶é—´ç†”æ–­å™¨ï¼Œä¸‰æ€æœºåˆ¶
- âœ… **æœåŠ¡é™çº§**ï¼šç¼“å­˜å›é€€ + Mock å›é€€
- âœ… **æ³›åŒ–è°ƒç”¨**ï¼šæ— éœ€æ¥å£å®šä¹‰å³å¯è°ƒç”¨è¿œç¨‹æœåŠ¡
- âœ… **SPI æ‰©å±•æœºåˆ¶**ï¼šæ˜“äºæ‰©å±•è‡ªå®šä¹‰ç»„ä»¶

### ç”Ÿäº§çº§ç‰¹æ€§
- ğŸ”’ **çº¿ç¨‹å®‰å…¨**ï¼šæ— é”å¹¶å‘è®¾è®¡ï¼ŒCAS è‡ªæ—‹ä¼˜åŒ–
- ğŸ“Š **ç›‘æ§ç»Ÿè®¡**ï¼šæµé‡ç»Ÿè®¡ã€è¯·æ±‚æŒ‡æ ‡è®°å½•
- ğŸ’“ **å¿ƒè·³æ£€æµ‹**ï¼šè‡ªåŠ¨æ£€æµ‹ç©ºé—²è¿æ¥å¹¶ä¿æŒæ´»è·ƒ
- ğŸ”„ **è¿æ¥å¤ç”¨**ï¼šè¿æ¥æ± ç®¡ç†ï¼Œé¿å…é‡å¤å»ºè¿
- âš¡ **æ€§èƒ½ä¼˜åŒ–**ï¼šç¼–è§£ç å™¨ç¼“å­˜ã€ç¯å½¢ç¼“å†²åŒºã€çº³ç§’çº§æ—¶é—´æˆ³

---

## å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒè¦æ±‚

- Java 17+
- Maven 3.x
- Zookeeper 3.x (å¯é€‰ï¼Œç”¨äºæœåŠ¡æ³¨å†Œå‘ç°)

### å®‰è£…ä¾èµ–

```bash
cd my_rpc
mvn clean install
```

### 1. å®šä¹‰æœåŠ¡æ¥å£

```java
package org.cade.rpc.api;

public interface Add {
    int add(int a, int b);
}
```

### 2. å®ç°æœåŠ¡æ¥å£

```java
package org.cade.rpc.provider;

import demo.api.Add;

public class AddImpl implements Add {
    @Override
    public int add(int a, int b) {
        return a + b;
    }
}
```

### 3. å¯åŠ¨æœåŠ¡æä¾›è€… (Provider)

```java
package org.cade.rpc.provider;

import demo.api.Add;
import demo.api.AddImpl;

public class ProviderApp {
    public static void main(String[] args) throws Exception {
        // åˆ›å»ºé…ç½®
        ProviderProperties properties = new ProviderProperties();
        properties.setHost("127.0.0.1");
        properties.setPort(10086);

        // é…ç½®æ³¨å†Œä¸­å¿ƒ
        properties.getRegistryConfig().setConnectString("localhost:2181");
        properties.getRegistryConfig().setRegistryType("zookeeper");

        // åˆ›å»ºæœåŠ¡å™¨å¹¶æ³¨å†ŒæœåŠ¡
        ProviderServer server = new ProviderServer(properties);
        server.register(Add.class, new AddImpl());

        // å¯åŠ¨æœåŠ¡
        server.start();
        System.out.println("Provider started on port 10086");
    }
}
```

**å¯åŠ¨å‘½ä»¤ï¼š**
```bash
mvn exec:java -Dexec.mainClass="demo.ProviderApp"
```

### 4. å¯åŠ¨æœåŠ¡æ¶ˆè´¹è€… (Consumer)

```java
package org.cade.rpc.comsumer;

import demo.api.Add;

public class ConsuerApp {
    public static void main(String[] args) throws Exception {
        // åˆ›å»ºé…ç½®
        ConsumerProperties properties = new ConsumerProperties();
        properties.getRegistryConfig().setConnectString("localhost:2181");
        properties.getRegistryConfig().setRegistryType("zookeeper");

        // åˆ›å»ºä»£ç†å·¥å‚
        ConsumerProxyFactory factory = new ConsumerProxyFactory(properties);

        // è·å–æœåŠ¡ä»£ç†
        Add add = factory.getConsumerProxy(Add.class);

        // è°ƒç”¨è¿œç¨‹æœåŠ¡
        int result = add.add(10, 20);
        System.out.println("Result: " + result);  // è¾“å‡º: Result: 30
    }
}
```

**å¯åŠ¨å‘½ä»¤ï¼š**
```bash
mvn exec:java -Dexec.mainClass="demo.ConsuerApp"
```

---

## æ ¸å¿ƒåŠŸèƒ½

### 1. å¤šç§åºåˆ—åŒ–æ–¹å¼

æ¡†æ¶æ”¯æŒé€šè¿‡ SPI æœºåˆ¶æ‰©å±•åºåˆ—åŒ–å™¨ï¼Œé»˜è®¤æä¾›ä¸¤ç§å®ç°ï¼š

| åºåˆ—åŒ–å™¨ | ä»£ç  | ç‰¹ç‚¹ | é€‚ç”¨åœºæ™¯ |
|---------|------|------|---------|
| **JSON** | 0 | å¯è¯»æ€§å¼ºï¼Œè·¨è¯­è¨€ | è°ƒè¯•ã€è·¨è¯­è¨€äº’é€š |
| **Hessian** | 1 | äºŒè¿›åˆ¶ï¼Œé«˜æ•ˆ | Java ç³»ç»Ÿé—´é«˜æ€§èƒ½è°ƒç”¨ |

**é…ç½®æ–¹å¼ï¼š**
```java
// Provider
properties.setSerializer("json");  // æˆ– "hessian"

// Consumer
properties.setSerializer("json");  // éœ€ä¸ Provider ä¸€è‡´
```

### 2. æ™ºèƒ½æ•°æ®å‹ç¼©

æ ¹æ®æ•°æ®å¤§å°è‡ªåŠ¨å†³å®šæ˜¯å¦å‹ç¼©ï¼Œé¿å…å°æ•°æ®å‹ç¼©ååè€Œå¢å¤§çš„é—®é¢˜ã€‚

| å‹ç¼©ç®—æ³• | ä»£ç  | å‹ç¼©é˜ˆå€¼ | ç‰¹ç‚¹ |
|---------|------|---------|------|
| **None** | 0 | - | æ— å‹ç¼© |
| **GZIP** | 1 | 512 å­—èŠ‚ | ä¸­ç­‰å‹ç¼©ç‡ï¼Œå¹¿æ³›å…¼å®¹ |
| **Zstandard** | 2 | 256 å­—èŠ‚ | é«˜å‹ç¼©ç‡ï¼Œé«˜é€Ÿåº¦ï¼ˆæ¨èï¼‰|

**é…ç½®æ–¹å¼ï¼š**
```java
properties.setCompress("zstd");  // "none", "gzip", "zstd"
```

### 3. è´Ÿè½½å‡è¡¡ç­–ç•¥

| ç­–ç•¥ | é…ç½®å€¼ | è¯´æ˜ |
|------|--------|------|
| **Random** | random | éšæœºé€‰æ‹©ï¼Œå‡åŒ€åˆ†å¸ƒ |
| **RoundRobin** | roundrobin | è½®è¯¢ï¼Œä¾æ¬¡é€‰æ‹© |

**é…ç½®æ–¹å¼ï¼š**
```java
properties.setLoadBalancePolicy("random");  // æˆ– "roundrobin"
```

### 4. é‡è¯•ç­–ç•¥

| ç­–ç•¥ | é…ç½®å€¼ | è¯´æ˜ |
|------|--------|------|
| **RetrySame** | same | é‡è¯•åŒä¸€èŠ‚ç‚¹ï¼ŒæŒ‡æ•°é€€é¿ (100ms â†’ 200ms â†’ 400ms) |
| **Failover** | faiover | æ•…éšœè½¬ç§»åˆ°å…¶ä»–èŠ‚ç‚¹ |
| **FailoverOnce** | failoveronce | ä»…ä¸€æ¬¡æ•…éšœè½¬ç§» |
| **Forking** | forking | å¹¶è¡Œè¯·æ±‚å¤šä¸ªèŠ‚ç‚¹ï¼Œä»»æ„æˆåŠŸå³è¿”å› |

**é…ç½®æ–¹å¼ï¼š**
```java
properties.setRetryPolicy("failover");
```

### 5. é™æµä¿æŠ¤

æ¡†æ¶æä¾›ä¸¤çº§é™æµä¿æŠ¤ï¼š

**å…¨å±€é™æµï¼š**
```java
// Provider
properties.setGlobelMaxRequest(1000000);  // å…¨å±€æœ€å¤§å¹¶å‘æ•°

// Consumer
properties.setRpcPreSecond(100000);  // æ¯ç§’æœ€å¤§è¯·æ±‚æ•°
```

**å•è¿æ¥é™æµï¼š**
```java
// Provider
properties.setPreConsumerMax(1000000);  // å•è¿æ¥æœ€å¤§è¯·æ±‚æ•°

// Consumer
properties.setRpcPreChannelSecond(1000000);  // å•è¿æ¥æ¯ç§’æœ€å¤§è¯·æ±‚æ•°
```

### 6. ç†”æ–­å™¨

åŸºäºå“åº”æ—¶é—´çš„ç†”æ–­å™¨ï¼Œé˜²æ­¢çº§è”æ•…éšœï¼š

**ä¸‰æ€æœºåˆ¶ï¼š**
- **CLOSEDï¼ˆå…³é—­ï¼‰**ï¼šæ­£å¸¸å¤„ç†è¯·æ±‚
- **OPENï¼ˆæ‰“å¼€ï¼‰**ï¼šæ‹’ç»æ‰€æœ‰è¯·æ±‚
- **HALF_OPENï¼ˆåŠå¼€ï¼‰**ï¼šå…è®¸éƒ¨åˆ†è¯·æ±‚é€šè¿‡ï¼Œæµ‹è¯•æœåŠ¡æ˜¯å¦æ¢å¤

**é…ç½®ï¼š**
```java
// å¤±è´¥ç‡é˜ˆå€¼ï¼ˆé»˜è®¤ 50%ï¼‰
properties.setSlowRequestBreakRatio(0.5);
```

**å†…éƒ¨å‚æ•°ï¼š**
- æ—¶é—´çª—å£ï¼š5 ç§’
- æœ€å°è¯·æ±‚æ•°ï¼š10
- ç†”æ–­æŒç»­æ—¶é—´ï¼š100 ç§’

### 7. æœåŠ¡é™çº§

å½“ RPC è°ƒç”¨å¤±è´¥æ—¶ï¼Œè‡ªåŠ¨è§¦å‘é™çº§ï¼š

1. **CacheFallback**ï¼šè¿”å›ç¼“å­˜çš„å†å²æˆåŠŸç»“æœ
2. **MockFallback**ï¼šè¿”å› Mock æ•°æ®ï¼ˆnullã€0ã€falseã€ç©ºé›†åˆç­‰ï¼‰

**è‡ªå®šä¹‰ Fallbackï¼š**
```java
@RPCFallback
public class ConsumerAdd implements Add {
    @Override
    public int add(int a, int b) {
        return -1;  // é™çº§è¿”å›å€¼
    }
}
```

### 8. æ³›åŒ–è°ƒç”¨

æ— éœ€æ¥å£å®šä¹‰å³å¯è°ƒç”¨è¿œç¨‹æœåŠ¡ï¼š

```java
GenericConsumer consumer = factory.getConsumerProxy(GenericConsumer.class);

Object result = consumer.$invoke(
    "org.cade.rpc.api.Add",           // æœåŠ¡å…¨é™å®šå
    "add",                             // æ–¹æ³•å
    new String[]{"int", "int"},        // å‚æ•°ç±»å‹
    new Object[]{10, 20}               // å‚æ•°å€¼
);

System.out.println(result);  // 30
```

---

## æŠ€æœ¯å®ç°

### æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Application Layer                    â”‚
â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚           â”‚   Consumer   â”‚      â”‚   Provider   â”‚        â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚                      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            RPC Framework Layer          â”‚               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Proxy & Invocation     â”‚  â”‚  Service Registry â”‚    â”‚
â”‚  â”‚  - JDK Dynamic Proxy    â”‚  â”‚  - Reflection     â”‚    â”‚
â”‚  â”‚  - Generic Call         â”‚  â”‚  - SPI Loader     â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                â”‚                        â”‚               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚         Circuit Breaker & Fallback              â”‚   â”‚
â”‚  â”‚         Retry & LoadBalance                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                â”‚                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚         Serialization & Compression           â”‚   â”‚
â”‚  â”‚         - JSON / Hessian                      â”‚   â”‚
â”‚  â”‚         - GZIP / Zstd                         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       Network Communication Layer (Netty)            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚   Encoder / Decoder / Handler Pipeline       â”‚   â”‚
â”‚  â”‚   - MsgEncoder / MsgDecoder                  â”‚   â”‚
â”‚  â”‚   - HeartbeatHandler                         â”‚   â”‚
â”‚  â”‚   - TrafficRecordHandler                     â”‚   â”‚
â”‚  â”‚   - LimitHandler                             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ¶ˆæ¯åè®®

**Wire Format:**

```
+--------+--------+----------+------+-------------+---------+
| Length | Magic  | Version  | Type | Ser + Comp  | Payload |
| 4 bytes| 4 bytes| 8 bytes  |1 byte|   1 byte    | N bytes |
+--------+--------+----------+------+-------------+---------+
|  æ•´æ•°   | "cade" |"10.00.00"|  1-4 | é«˜4ä½ | ä½4ä½ |  JSON   |
+--------+--------+----------+------+-------------+---------+
```

**æ¶ˆæ¯ç±»å‹ï¼š**
- 1 = Request (RPC è¯·æ±‚)
- 2 = Response (RPC å“åº”)
- 3 = HeartbeatRequest (å¿ƒè·³è¯·æ±‚)
- 4 = HeartbeatResponse (å¿ƒè·³å“åº”)

**Ser + Comp å­—èŠ‚ï¼š**
- é«˜ 4 ä½ï¼šåºåˆ—åŒ–ç±»å‹ (0-15)
- ä½ 4 ä½ï¼šå‹ç¼©ç±»å‹ (0-15)

**ç¤ºä¾‹ï¼š**
```
0x01 = JSON åºåˆ—åŒ– + GZIP å‹ç¼© (0000 0001)
0x12 = Hessian åºåˆ—åŒ– + Zstd å‹ç¼© (0001 0010)
```

### è¯·æ±‚å¤„ç†æµç¨‹

**Consumer ç«¯ï¼š**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Method Call â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. ä»æ³¨å†Œä¸­å¿ƒè·å–æœåŠ¡åˆ—è¡¨                 â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. é€šè¿‡è´Ÿè½½å‡è¡¡é€‰æ‹©èŠ‚ç‚¹                   â”‚
â”‚    - CircuitBreaker è¿‡æ»¤ OPEN èŠ‚ç‚¹      â”‚
â”‚    - LoadBalancer.select()             â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. æ£€æŸ¥é™æµ                              â”‚
â”‚    - GlobalLimiter (ä¿¡å·é‡)             â”‚
â”‚    - ChannelLimiter (ä»¤ç‰Œæ¡¶)            â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. æ„å»º Request å¹¶åºåˆ—åŒ–                 â”‚
â”‚    - serviceName, methodName, params   â”‚
â”‚    - Serialization (JSON/Hessian)      â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. å‹ç¼© (å¦‚æœéœ€è¦)                       â”‚
â”‚    - æ ¹æ®é˜ˆå€¼åˆ¤æ–­                        â”‚
â”‚    - GZIP / Zstd                       â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. ç¼–ç å¹¶å‘é€                            â”‚
â”‚    - MsgEncoder                        â”‚
â”‚    - Channel.writeAndFlush()           â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. ç­‰å¾…å“åº”                              â”‚
â”‚    - CompletableFuture.get(timeout)    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€ æˆåŠŸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚                            â”‚
       â””â”€ å¤±è´¥ â”€â”€â”                  â”‚
                 â”‚                  â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
        â”‚ 8. è®°å½•æŒ‡æ ‡       â”‚        â”‚
        â”‚ - CircuitBreaker â”‚        â”‚
        â”‚ - Fallback Cache â”‚        â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
                 â”‚                  â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
        â”‚ 9. é‡è¯•ç­–ç•¥       â”‚        â”‚
        â”‚ - RetryPolicy    â”‚        â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
                 â”‚                  â”‚
                 â”œâ”€ é‡è¯•æˆåŠŸ â”€â”€â”€â”€â”€â”€â”€â”¤
                 â”‚                  â”‚
                 â””â”€ é‡è¯•å¤±è´¥ â”€â”€â”    â”‚
                               â”‚    â”‚
                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â–¼â”€â”€â”€â”
                      â”‚ 10. è¿”å›ç»“æœ     â”‚
                      â”‚  æˆ–æ‰§è¡Œ Fallback â”‚
                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Provider ç«¯ï¼š**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Receive Request â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. è§£ç                       â”‚
â”‚    - MsgDecoder             â”‚
â”‚    - Verify Magic & Version â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. è§£å‹ç¼©                    â”‚
â”‚    - GZIP / Zstd            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. ååºåˆ—åŒ–                  â”‚
â”‚    - JSON / Hessian         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. é™æµæ£€æŸ¥                  â”‚
â”‚    - LimitHandler           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. æŸ¥æ‰¾æœåŠ¡å®ç°              â”‚
â”‚    - ProviderRegistry       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. åå°„è°ƒç”¨                  â”‚
â”‚    - Method.invoke()        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. æ„å»º Response             â”‚
â”‚    - å°è£…ç»“æœæˆ–å¼‚å¸¸          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 8. åºåˆ—åŒ– + å‹ç¼© + ç¼–ç       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 9. å‘é€å“åº”                  â”‚
â”‚    - Channel.writeAndFlush()â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å¹¶å‘å®‰å…¨æœºåˆ¶

æ¡†æ¶åœ¨å¤šå¤„é‡‡ç”¨æ— é”å¹¶å‘è®¾è®¡ï¼š

**1. RateLimiterï¼ˆä»¤ç‰Œæ¡¶ï¼‰**
```java
// CAS è‡ªæ—‹ï¼Œé¿å… synchronized å¼€é”€
private final AtomicLong tokens;
private final AtomicLong lastRefillTimestamp;

private void refill() {
    long now = System.nanoTime();
    long lastRefill = lastRefillTimestamp.get();
    long elapsed = now - lastRefill;
    long newTokens = elapsed / nanosPerToken;
    if (newTokens <= 0) return;

    // ä¿ç•™çº³ç§’ç²¾åº¦ä½™é‡ï¼Œé¿å…ç²¾åº¦æŸå¤±
    long newLastRefill = lastRefill + newTokens * nanosPerToken;

    // CAS æ›´æ–°
    if (lastRefillTimestamp.compareAndSet(lastRefill, newLastRefill)) {
        tokens.updateAndGet(current -> Math.min(capacity, current + newTokens));
    }
}
```

**2. CircuitBreaker RingBuffer**
```java
// æ— é”ç¯å½¢ç¼“å†²åŒº
private final AtomicReferenceArray<T> buffer;
private final AtomicInteger writeIndex = new AtomicInteger(0);
private final AtomicReference<T> tail = new AtomicReference<>(null);

public boolean compareAndSet(T expected, T update) {
    if (tail.compareAndSet(expected, update)) {
        writeToBuffer(update);
        return true;
    }
    return false;
}
```

**3. ConnectionManager**
```java
// ConcurrentHashMap + computeIfAbsent åŸå­æ“ä½œ
private final ConcurrentHashMap<String, ChannelWrapper> channelMap;

public Channel getChannel(Metadata metadata) {
    String key = metadata.getHost() + ":" + metadata.getPort();
    return channelMap.computeIfAbsent(key, k -> createChannel(metadata))
                     .getChannel();
}
```

### SPI æ‰©å±•æœºåˆ¶

æ¡†æ¶ä½¿ç”¨ Java ServiceLoader å®ç°æ’ä»¶åŒ–æ‰©å±•ã€‚

**æ‰©å±•ç‚¹ï¼š**
- `Serializer` - åºåˆ—åŒ–å™¨
- `Compression` - å‹ç¼©å™¨
- `LoadBalancer` - è´Ÿè½½å‡è¡¡å™¨
- `RetryPolicy` - é‡è¯•ç­–ç•¥

**é…ç½®æ–‡ä»¶è·¯å¾„ï¼š**
```
src/main/resources/META-INF/services/
â”œâ”€â”€ org.cade.rpc.serialize.Serializer
â”œâ”€â”€ org.cade.rpc.compress.Compression
â”œâ”€â”€ org.cade.rpc.loadbalance.LoadBalancer
â””â”€â”€ org.cade.rpc.retry.RetryPolicy
```

**ç¤ºä¾‹ï¼šæ‰©å±•è‡ªå®šä¹‰åºåˆ—åŒ–å™¨**

1. å®ç° `Serializer` æ¥å£ï¼š
```java
package com.example;

import org.cade.rpc.serialize.Serializer;
import org.cade.rpc.spi.SPI;

@SPI("protobuf")
public class ProtobufSerializer implements Serializer {
    @Override
    public String getName() {
        return "protobuf";
    }

    @Override
    public int code() {
        return 2;  // 0-15
    }

    @Override
    public byte[] serialize(Object obj) {
        // Protobuf åºåˆ—åŒ–å®ç°
    }

    @Override
    public <T> T deserialize(byte[] bytes, Class<T> clazz) {
        // Protobuf ååºåˆ—åŒ–å®ç°
    }
}
```

2. åœ¨ `META-INF/services/org.cade.rpc.serialize.Serializer` ä¸­æ³¨å†Œï¼š
```
com.example.ProtobufSerializer
```

3. é…ç½®ä½¿ç”¨ï¼š
```java
properties.setSerializer("protobuf");
```

---

## é…ç½®è¯¦è§£

### ProviderProperties

| é…ç½®é¡¹ | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|--------|------|
| host | String | "127.0.0.1" | ç»‘å®šåœ°å€ |
| port | int | 10086 | ç»‘å®šç«¯å£ |
| workerThreadNumber | int | 4 | Netty å·¥ä½œçº¿ç¨‹æ•° |
| globelMaxRequest | int | 1000000 | å…¨å±€æœ€å¤§å¹¶å‘è¯·æ±‚æ•° |
| preConsumerMax | int | 1000000 | å•è¿æ¥æœ€å¤§è¯·æ±‚æ•° |
| serializer | String | "json" | åºåˆ—åŒ–æ–¹å¼ (json/hessian) |
| compress | String | "gzip" | å‹ç¼©æ–¹å¼ (none/gzip/zstd) |
| registryConfig | RegistryConfig | - | æ³¨å†Œä¸­å¿ƒé…ç½® |

### ConsumerProperties

| é…ç½®é¡¹ | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|--------|------|
| workThreadNum | int | 4 | å·¥ä½œçº¿ç¨‹æ•° |
| connectTimeoutMS | int | 3000 | è¿æ¥è¶…æ—¶ (æ¯«ç§’) |
| requestTimeoutMS | int | 3000 | å•æ¬¡è¯·æ±‚è¶…æ—¶ (æ¯«ç§’) |
| functionTimeoutMS | int | 10000 | å‡½æ•°æ€»è¶…æ—¶ï¼ŒåŒ…æ‹¬é‡è¯• (æ¯«ç§’) |
| loadBalancePolicy | String | "random" | è´Ÿè½½å‡è¡¡ç­–ç•¥ |
| retryPolicy | String | "same" | é‡è¯•ç­–ç•¥ |
| rpcPreSecond | int | 100000 | å…¨å±€æ¯ç§’æœ€å¤§è¯·æ±‚æ•° |
| rpcPreChannelSecond | int | 1000000 | å•è¿æ¥æ¯ç§’æœ€å¤§è¯·æ±‚æ•° |
| slowRequestBreakRatio | double | 0.5 | ç†”æ–­å¤±è´¥ç‡é˜ˆå€¼ (0.0-1.0) |
| serializer | String | "json" | åºåˆ—åŒ–æ–¹å¼ |
| compress | String | "zstd" | å‹ç¼©æ–¹å¼ |
| registryConfig | RegistryConfig | - | æ³¨å†Œä¸­å¿ƒé…ç½® |

### RegistryConfig

| é…ç½®é¡¹ | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|--------|------|
| registryType | String | "zookeeper" | æ³¨å†Œä¸­å¿ƒç±»å‹ (zookeeper/etcd) |
| connectString | String | "localhost:2181" | æ³¨å†Œä¸­å¿ƒè¿æ¥åœ°å€ |

---

## æ‰©å±•å¼€å‘

### è‡ªå®šä¹‰è´Ÿè½½å‡è¡¡å™¨

```java
package com.example;

import org.cade.rpc.loadbalance.LoadBalancer;
import org.cade.rpc.register.Metadata;
import org.cade.rpc.spi.SPI;
import java.util.List;

@SPI("weighted")
public class WeightedLoadBalancer implements LoadBalancer {
    @Override
    public String getName() {
        return "weighted";
    }

    @Override
    public Metadata select(List<Metadata> metadataList) {
        // æ ¹æ®æƒé‡é€‰æ‹©èŠ‚ç‚¹
        // ...
    }
}
```

åœ¨ `META-INF/services/org.cade.rpc.loadbalance.LoadBalancer` ä¸­æ³¨å†Œï¼š
```
com.example.WeightedLoadBalancer
```

### è‡ªå®šä¹‰é‡è¯•ç­–ç•¥

```java
package com.example;

import org.cade.rpc.retry.RetryPolicy;
import org.cade.rpc.retry.RetryContext;
import org.cade.rpc.message.Response;
import org.cade.rpc.spi.SPI;

@SPI("exponential")
public class ExponentialRetryPolicy implements RetryPolicy {
    @Override
    public Response retry(RetryContext context) throws Exception {
        int maxRetries = 5;
        long baseDelay = 100;

        for (int i = 0; i < maxRetries; i++) {
            try {
                // æŒ‡æ•°é€€é¿å»¶è¿Ÿ
                Thread.sleep(baseDelay * (1L << i));

                Metadata provider = context.getLoadBalancer()
                    .select(context.getAllService());

                Response response = context.getRetry()
                    .apply(provider)
                    .get(context.getRequestTimeout(), TimeUnit.MILLISECONDS);

                if (response.getCode() == 0) {
                    return response;
                }
            } catch (Exception e) {
                if (i == maxRetries - 1) {
                    throw e;
                }
            }
        }
        throw new Exception("Retry failed");
    }
}
```

---

## ä¸è¶³ä¸æ”¹è¿›

### å½“å‰ä¸è¶³

#### 1. åŠŸèƒ½å±‚é¢

**âŒ ç¼ºå°‘æ³¨å†Œä¸­å¿ƒå®ç°**
- ETCD æ³¨å†Œä¸­å¿ƒä»…æœ‰æ¥å£å®šä¹‰ï¼Œæœªå®Œæˆå®ç°
- å»ºè®®ï¼šè¡¥å…… ETCD å®ç°ï¼Œå¹¶æ·»åŠ  Nacosã€Consul ç­‰ä¸»æµæ³¨å†Œä¸­å¿ƒæ”¯æŒ

**âŒ æ³›åŒ–è°ƒç”¨æ”¯æŒä¸å®Œæ•´**
- å½“å‰æ³›åŒ–è°ƒç”¨éœ€è¦æ‰‹åŠ¨æŒ‡å®šå‚æ•°ç±»å‹å­—ç¬¦ä¸²
- å»ºè®®ï¼šæ”¯æŒè‡ªåŠ¨ç±»å‹æ¨æ–­ï¼Œæä¾›æ›´å‹å¥½çš„ API

**âŒ ç¼ºå°‘æœåŠ¡æ²»ç†åŠŸèƒ½**
- æ— æœåŠ¡ç‰ˆæœ¬ç®¡ç†
- æ— æœåŠ¡åˆ†ç»„éš”ç¦»
- æ— åŠ¨æ€é…ç½®ä¸­å¿ƒé›†æˆ
- å»ºè®®ï¼šå‚è€ƒ Dubbo å®ç°å®Œæ•´çš„æœåŠ¡æ²»ç†èƒ½åŠ›

**âŒ ç›‘æ§èƒ½åŠ›ä¸è¶³**
- ä»…æœ‰åŸºç¡€çš„æµé‡ç»Ÿè®¡
- ç¼ºå°‘è¯·æ±‚é“¾è·¯è¿½è¸ªï¼ˆTracingï¼‰
- ç¼ºå°‘ Metrics å¯¼å‡ºï¼ˆPrometheusï¼‰
- å»ºè®®ï¼šé›†æˆ OpenTelemetry æˆ– Micrometer

#### 2. æ€§èƒ½å±‚é¢

**âš ï¸ åºåˆ—åŒ–æ€§èƒ½å¾…ä¼˜åŒ–**
- fastjson2 è™½å¿«ä½†ä¸å¦‚ Protobufã€Kryo
- å»ºè®®ï¼šæ·»åŠ  Protobufã€Kryo åºåˆ—åŒ–å™¨

**âš ï¸ è¿æ¥ç®¡ç†å¯ä¼˜åŒ–**
- å½“å‰è¿æ¥æ± è¾ƒç®€å•ï¼Œæ— è¿æ¥å¥åº·æ£€æŸ¥
- æ— è¿æ¥é¢„çƒ­æœºåˆ¶
- å»ºè®®ï¼šå®ç°è¿æ¥å¥åº·æ£€æŸ¥ã€å¿ƒè·³ä¿æ´»ã€è¿æ¥é¢„çƒ­

**âš ï¸ ç¼–è§£ç æ€§èƒ½å¯æå‡**
- æ¯æ¬¡è¯·æ±‚éƒ½è¿›è¡Œ JSON åºåˆ—åŒ–ï¼ŒGC å‹åŠ›è¾ƒå¤§
- å»ºè®®ï¼šä½¿ç”¨å¯¹è±¡æ± ï¼ˆå¦‚ Netty çš„ Recyclerï¼‰å¤ç”¨å¯¹è±¡

#### 3. å¯é æ€§å±‚é¢

**âš ï¸ ç†”æ–­å™¨å‚æ•°å›ºå®š**
- æ—¶é—´çª—å£ã€ç†”æ–­æ—¶é—´ç­‰å‚æ•°ç¡¬ç¼–ç 
- å»ºè®®ï¼šæ”¯æŒåŠ¨æ€é…ç½®ï¼Œå¯æ ¹æ®ä¸šåŠ¡åœºæ™¯è°ƒæ•´

**âš ï¸ é™æµå™¨åŠŸèƒ½å•ä¸€**
- ä»…æ”¯æŒä»¤ç‰Œæ¡¶å’Œä¿¡å·é‡
- ç¼ºå°‘æ»‘åŠ¨çª—å£ã€æ¼æ¡¶ç­‰ç®—æ³•
- å»ºè®®ï¼šæä¾›æ›´å¤šé™æµç®—æ³•é€‰æ‹©

**âš ï¸ å¼‚å¸¸å¤„ç†ä¸å®Œå–„**
- éƒ¨åˆ†å¼‚å¸¸ç›´æ¥æŠ›å‡ºï¼Œæœªåšé™çº§å¤„ç†
- å»ºè®®ï¼šå®Œå–„å¼‚å¸¸åˆ†ç±»ï¼ŒåŒºåˆ†å¯é‡è¯•å¼‚å¸¸å’Œä¸å¯é‡è¯•å¼‚å¸¸

#### 4. ä»£ç è´¨é‡å±‚é¢

**âš ï¸ ç¼ºå°‘å•å…ƒæµ‹è¯•**
- æ ¸å¿ƒç»„ä»¶ç¼ºå°‘å•å…ƒæµ‹è¯•è¦†ç›–
- å»ºè®®ï¼šæ·»åŠ å•å…ƒæµ‹è¯•ï¼Œç›®æ ‡è¦†ç›–ç‡ > 80%

**âš ï¸ æ–‡æ¡£ä¸è¶³**
- ç¼ºå°‘è¯¦ç»†çš„ API æ–‡æ¡£å’Œè®¾è®¡æ–‡æ¡£
- å»ºè®®ï¼šè¡¥å…… Javadoc å’Œæ¶æ„è®¾è®¡æ–‡æ¡£

**âš ï¸ æ—¥å¿—ä¸è§„èŒƒ**
- æ—¥å¿—çº§åˆ«ä½¿ç”¨ä¸è§„èŒƒ
- ç¼ºå°‘å…³é”®æ“ä½œçš„æ—¥å¿—è®°å½•
- å»ºè®®ï¼šç»Ÿä¸€æ—¥å¿—è§„èŒƒï¼Œæ·»åŠ  MDC æ”¯æŒ

**âš ï¸ åŒ…åæ‹¼å†™é”™è¯¯**
- `comsumer` åº”ä¸º `consumer`
- å»ºè®®ï¼šç»Ÿä¸€ä¿®æ­£åŒ…å

#### 5. æ‰©å±•æ€§å±‚é¢

**âš ï¸ SPI æœºåˆ¶ä¸å¤Ÿçµæ´»**
- ä»…æ”¯æŒå•ä¾‹åŠ è½½ï¼Œæ— æ³•æ”¯æŒå‚æ•°åŒ–æ„é€ 
- å»ºè®®ï¼šå‚è€ƒ Dubbo SPIï¼Œæ”¯æŒè‡ªé€‚åº”æ‰©å±•å’Œå‚æ•°åŒ–å®ä¾‹

**âš ï¸ åè®®æ‰©å±•æ€§ä¸è¶³**
- å½“å‰ä»…æ”¯æŒè‡ªå®šä¹‰åè®®
- å»ºè®®ï¼šæ”¯æŒå¤šåè®®ï¼ˆHTTP/2ã€gRPCã€Thriftï¼‰

### æ”¹è¿›å»ºè®®

#### çŸ­æœŸæ”¹è¿›ï¼ˆ1-2å‘¨ï¼‰

1. **ä¿®å¤åŒ…åæ‹¼å†™é”™è¯¯** (`comsumer` â†’ `consumer`)
2. **è¡¥å……å•å…ƒæµ‹è¯•**ï¼Œæ ¸å¿ƒç»„ä»¶æµ‹è¯•è¦†ç›–ç‡è¾¾åˆ° 60%+
3. **å®Œå–„æ—¥å¿—è®°å½•**ï¼Œæ·»åŠ å…³é”®æ“ä½œæ—¥å¿—å’Œ MDC
4. **æ·»åŠ é…ç½®æ ¡éªŒ**ï¼Œå¯åŠ¨æ—¶æ ¡éªŒé…ç½®åˆæ³•æ€§
5. **ä¼˜åŒ–å¼‚å¸¸å¤„ç†**ï¼ŒåŒºåˆ†å¯é‡è¯•å’Œä¸å¯é‡è¯•å¼‚å¸¸

#### ä¸­æœŸæ”¹è¿›ï¼ˆ1-2æœˆï¼‰

1. **å®ç° ETCD æ³¨å†Œä¸­å¿ƒ**
2. **æ·»åŠ  Nacos æ³¨å†Œä¸­å¿ƒæ”¯æŒ**
3. **é›†æˆ Micrometer**ï¼Œå¯¼å‡º Metrics åˆ° Prometheus
4. **å®ç°æœåŠ¡ç‰ˆæœ¬å’Œåˆ†ç»„ç®¡ç†**
5. **æ·»åŠ  Protobufã€Kryo åºåˆ—åŒ–å™¨**
6. **ä¼˜åŒ–è¿æ¥æ± **ï¼Œæ·»åŠ å¥åº·æ£€æŸ¥å’Œé¢„çƒ­
7. **å®Œå–„æ³›åŒ–è°ƒç”¨**ï¼Œæ”¯æŒç±»å‹è‡ªåŠ¨æ¨æ–­

#### é•¿æœŸæ”¹è¿›ï¼ˆ3-6æœˆï¼‰

1. **é›†æˆåˆ†å¸ƒå¼è¿½è¸ª**ï¼ˆOpenTelemetryï¼‰
2. **å®ç°åŠ¨æ€é…ç½®ä¸­å¿ƒ**ï¼ˆApollo/Nacos Configï¼‰
3. **æ”¯æŒå¤šåè®®**ï¼ˆHTTP/2ã€gRPCï¼‰
4. **å®ç°æœåŠ¡ Mesh é›†æˆ**
5. **æ·»åŠ ç®¡ç†æ§åˆ¶å°**
6. **æ€§èƒ½å‹æµ‹å’Œä¼˜åŒ–**ï¼ŒTPS è¾¾åˆ° 10w+
7. **ç¼–å†™å®Œæ•´çš„ç”¨æˆ·æ–‡æ¡£å’Œå¼€å‘æ–‡æ¡£**

### æŠ€æœ¯å€ºåŠ¡æ¸…å•

| ä¼˜å…ˆçº§ | é¡¹ç›® | å·¥ä½œé‡ | é¢„æœŸæ”¶ç›Š |
|--------|------|--------|----------|
| ğŸ”´ é«˜ | åŒ…åæ‹¼å†™ä¿®æ­£ | 1h | ä»£ç è§„èŒƒ |
| ğŸ”´ é«˜ | è¡¥å……å•å…ƒæµ‹è¯• | 3d | è´¨é‡ä¿éšœ |
| ğŸ”´ é«˜ | å¼‚å¸¸åˆ†ç±»å’Œå¤„ç† | 2d | å¯é æ€§æå‡ |
| ğŸŸ¡ ä¸­ | ETCD æ³¨å†Œä¸­å¿ƒå®ç° | 3d | åŠŸèƒ½å®Œæ•´æ€§ |
| ğŸŸ¡ ä¸­ | Metrics å¯¼å‡º | 2d | å¯è§‚æµ‹æ€§ |
| ğŸŸ¡ ä¸­ | è¿æ¥æ± ä¼˜åŒ– | 3d | æ€§èƒ½æå‡ |
| ğŸŸ¢ ä½ | æœåŠ¡æ²»ç†åŠŸèƒ½ | 2w | ä¼ä¸šçº§èƒ½åŠ› |
| ğŸŸ¢ ä½ | åˆ†å¸ƒå¼è¿½è¸ª | 1w | å¯è§‚æµ‹æ€§ |
| ğŸŸ¢ ä½ | å¤šåè®®æ”¯æŒ | 2w | æ‰©å±•æ€§ |

---

## é¡¹ç›®ä¾èµ–

```xml
<dependencies>
    <!-- ç½‘ç»œé€šä¿¡ -->
    <dependency>
        <groupId>io.netty</groupId>
        <artifactId>netty-all</artifactId>
        <version>4.1.128.Final</version>
    </dependency>

    <!-- åºåˆ—åŒ– -->
    <dependency>
        <groupId>com.alibaba.fastjson2</groupId>
        <artifactId>fastjson2</artifactId>
        <version>2.0.60</version>
    </dependency>
    <dependency>
        <groupId>com.caucho</groupId>
        <artifactId>hessian</artifactId>
        <version>4.0.66</version>
    </dependency>

    <!-- å‹ç¼© -->
    <dependency>
        <groupId>com.github.luben</groupId>
        <artifactId>zstd-jni</artifactId>
        <version>1.5.5-11</version>
    </dependency>

    <!-- æ³¨å†Œä¸­å¿ƒ -->
    <dependency>
        <groupId>org.apache.curator</groupId>
        <artifactId>curator-x-discovery</artifactId>
        <version>5.9.0</version>
    </dependency>

    <!-- æ—¥å¿— -->
    <dependency>
        <groupId>ch.qos.logback</groupId>
        <artifactId>logback-classic</artifactId>
        <version>1.5.21</version>
    </dependency>

    <!-- å·¥å…· -->
    <dependency>
        <groupId>org.projectlombok</groupId>
        <artifactId>lombok</artifactId>
        <version>1.18.42</version>
    </dependency>
</dependencies>
```

---

## å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆ ServiceLoader åŠ è½½ä¸åˆ° SPI å®ç°ï¼Ÿ

**A:** ç¡®ä¿ SPI é…ç½®æ–‡ä»¶è·¯å¾„ä¸º `META-INF/services/`ï¼ˆæ³¨æ„æ˜¯ **services** å¤æ•°ï¼‰ï¼Œè€Œä¸æ˜¯ `META-INF/service/`ã€‚

### Q2: å¦‚ä½•è°ƒæ•´ç†”æ–­å™¨å‚æ•°ï¼Ÿ

**A:** å½“å‰ç†”æ–­å™¨å‚æ•°å›ºå®šåœ¨ä»£ç ä¸­ã€‚å¦‚éœ€è°ƒæ•´ï¼š
1. ä¿®æ”¹ `ResponseTimeCircuitBreaker` æ„é€ å‡½æ•°
2. æˆ–æ‰©å±•æ–°çš„ç†”æ–­å™¨å®ç°

### Q3: ä¸ºä»€ä¹ˆå‹ç¼©åæ•°æ®åè€Œå˜å¤§ï¼Ÿ

**A:** æ¡†æ¶å·²å®ç°æ™ºèƒ½å‹ç¼©ï¼Œä¼šæ ¹æ®é˜ˆå€¼åˆ¤æ–­æ˜¯å¦éœ€è¦å‹ç¼©ï¼š
- GZIP: 512 å­—èŠ‚ä»¥ä¸‹ä¸å‹ç¼©
- Zstd: 256 å­—èŠ‚ä»¥ä¸‹ä¸å‹ç¼©

### Q4: å¦‚ä½•æ”¯æŒè‡ªå®šä¹‰åºåˆ—åŒ–å™¨ï¼Ÿ

**A:** å‚è€ƒ [æ‰©å±•å¼€å‘](#æ‰©å±•å¼€å‘) ç« èŠ‚ï¼Œå®ç° `Serializer` æ¥å£å¹¶æ³¨å†Œåˆ° SPIã€‚

### Q5: Consumer è¿æ¥ Provider å¤±è´¥æ€ä¹ˆåŠï¼Ÿ

**A:** æ£€æŸ¥ï¼š
1. Provider æ˜¯å¦å·²å¯åŠ¨
2. Zookeeper æ˜¯å¦å¯è¿æ¥
3. æœåŠ¡æ˜¯å¦å·²æ³¨å†Œåˆ° Zookeeperï¼ˆæŸ¥çœ‹ `/cade_rpc` è·¯å¾„ï¼‰
4. ç½‘ç»œæ˜¯å¦å¯è¾¾ï¼ˆé˜²ç«å¢™ã€ç«¯å£ï¼‰

---

## è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ MIT è®¸å¯è¯ã€‚

---

## è´¡çŒ®

æ¬¢è¿è´¡çŒ®ä»£ç ã€æŠ¥å‘Šé—®é¢˜æˆ–æå‡ºæ”¹è¿›å»ºè®®ï¼

**è´¡çŒ®æŒ‡å—ï¼š**
1. Fork æœ¬ä»“åº“
2. åˆ›å»ºç‰¹æ€§åˆ†æ”¯ (`git checkout -b feature/AmazingFeature`)
3. æäº¤å˜æ›´ (`git commit -m 'Add some AmazingFeature'`)
4. æ¨é€åˆ°åˆ†æ”¯ (`git push origin feature/AmazingFeature`)
5. æäº¤ Pull Request

---

**æœ€åæ›´æ–°æ—¶é—´ï¼š** 2026-02-21
